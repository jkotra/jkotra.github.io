<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><base href=https://stdin.top/posts/https_parse_openssl/><meta name=description content="Integrate TLS with TCP to securely communicate ðŸ”’"><meta name=language content="en"><link rel=sitemap type=application/xml title=Sitemap href=https://stdin.top/sitemap.xml><title>Parse HTTPS website(s) in C with OpenSSL :: &lt;stdin></title><link rel=icon type=image/png href=/static/chip.png><meta property="og:title" content="Parse HTTPS website(s) in C with OpenSSL"><meta property="og:description" content="Integrate TLS with TCP to securely communicate ðŸ”’"><meta property="og:type" content="article"><meta property="og:url" content="https://stdin.top/posts/https_parse_openssl/"><meta property="og:image" content="https://stdin.top/images/YGtDgXv.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-20T20:07:40+05:30"><meta property="article:modified_time" content="2023-05-11T19:55:50+05:30"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://stdin.top/images/YGtDgXv.png"><meta name=twitter:title content="Parse HTTPS website(s) in C with OpenSSL"><meta name=twitter:description content="Integrate TLS with TCP to securely communicate ðŸ”’"><meta name=theme-color content="#2e2847"><link defer href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel=stylesheet><link defer href="https://fonts.googleapis.com/css2?family=Tangerine&display=swap" rel=stylesheet><script src=https://stdin.top/js/main.min.6a2ed298f6a8cafbfa5c622ca55cb5be5632cc37b845fc6b58d9d383cf7ec77e9faaedd88196d0d58c0040873d5689898701e5ed30cac06dae52c78f9c0ddc31.js integrity="sha512-ai7SmPaoyvv6XGIspVy1vlYyzDe4RfxrWNnTg89+x36fqu3YgZbQ1YwAQIc9VomJhwHl7TDKwG2uUsePnA3cMQ=="></script>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/fontawesome.min.css integrity="sha512-8jdwayz5n8F2cnW26l9vpV6+yGOcRAqz6HTu+DQ3FtVIAts2gTdlFZOGpYhvBMXkWEgxPN3Y22UWyZXuDowNLA==" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/regular.min.css integrity="sha512-qgtcTTDJDk6Fs9eNeN1tnuQwYjhnrJ8wdTVxJpUTkeafKKP6vprqRx5Sj/rB7Q57hoYDbZdtHR4krNZ/11zONg==" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/brands.min.css integrity="sha512-AMDXrE+qaoUHsd0DXQJr5dL4m5xmpkGLxXZQik2TvR2VCVKT/XRPQ4e/LTnwl84mCv+eFm92UG6ErWDtGM/Q5Q==" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/solid.min.css integrity="sha512-QN7X/bUbbeel9bbq6JVNJXk1Zowt+n+QPN+DjhEmTa4TdL1YPCsCey5JrvfRW8xp28LDYgGG/waNVdrhwMQmVQ==" crossorigin=anonymous><link rel=stylesheet type=text/css media=screen href=https://stdin.top/css/main.min.dc3edd6ae540bf87b9aeab2175e2a0d0f2445f17589e60d223f6d57cf330c8f3b6dced4c45491d9dd6b3d91aa4776adbda6cd10e2ec77fc67671618970ebd7ab.css integrity="sha512-3D7dauVAv4e5rqshdeKg0PJEXxdYnmDSI/bVfPMwyPO23O1MRUkdndaz2Rqkd2rb2mzRDi7Hf8Z2cWGJcOvXqw=="><link rel=stylesheet type=text/css media=screen href=https://stdin.top/css/custom.min.757b18759462b15e8897dc209b4b095bd251a2f738a618a40eea280f31a1a3f6edcb894da93e006c4aa6a1f6e1f67f3c083ea566d1a2ad2e9e7b0a68dc2a257a.css integrity="sha512-dXsYdZRisV6Il9wgm0sJW9JRovc4phikDuooDzGho/bty4lNqT4AbEqmofbh9n88CD6lZtGirS6eewpo3Coleg=="><link rel=stylesheet type=text/css href=https://stdin.top/css/dark.min.7a85efc733bdb0bf14b310fa5de03054b475ca1846babf715d4f15fd0863f9e7074ea0e3548e662a608d8710563460786a7df68ecde3e66abcfa6fcf21fa5888.css media="(prefers-color-scheme: dark)"><link rel=stylesheet type=text/css media=screen href=https://stdin.top/css/normalize.min.15dd2454cf02be612cd84be5a0307ecae7e9c84d08f88ab2d1e9332717d10fe9b63484bb4c5352072da0915d1a6d48fa41994fb99c120c891cca431b4448f44d.css integrity="sha512-Fd0kVM8CvmEs2EvloDB+yufpyE0I+Iqy0ekzJxfRD+m2NIS7TFNSBy2gkV0abUj6QZlPuZwSDIkcykMbREj0TQ=="><script async src="https://www.googletagmanager.com/gtag/js?id=G-YW8V9DTR0N"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YW8V9DTR0N",{anonymize_ip:!1})}</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8658473214995139" crossorigin=anonymous></script></head><body><div class="container wrapper"><div class=header><base href=https://stdin.top/><h1 class=site-title><a href=https://stdin.top/>&lt;stdin></a>
<span class=blinking-cursor>|</span></h1><div class=site-description><h2 class=cursive>My Thoughts, Trials and Adventures</h2><nav class="nav social"><ul class=flat><a href=mailto:jagadeesh@stdin.top title=Mail><i class="far fa-envelope"></i></a>
<a href=https://github.com/jkotra/ title=Github><i class="fab fa-github"></i></a>
<a href=https://twitter.com/jagadeesh_kotra title=Twitter><i class="fab fa-twitter"></i></a>
<a href=/index.xml title=RSS><i class="fas fa-rss"></i></a></ul></div><nav class=nav><ul class=flat><li><a href=/about/>About</a></li><li><a href=/tags/>Tags</a></li><li><a href=/portfolio/>Portfolio</a></li><li><a href=/pgp/>PGP</a></li></ul></nav></div><div class=post><div class=post-header><h1 class=title>Parse HTTPS website(s) in C with OpenSSL</h1><div class=meta>Posted at &mdash; Sep 20, 2020
| Last Modified on &mdash; May 11, 2023</div></div><div class=markdown><h1 id=introduction>Introduction</h1><p>In this article, I will explain how to parse a website that uses <code>HTTPS</code>. in the process, one must get a grip on OpenSSL and integrating it with TCP (TLS) to retrieve content.</p><h1 id=openssl>OpenSSL</h1><blockquote><p>OpenSSL is a software library for applications that secure communications over computer networks against eavesdropping or need to identify the party at the other end. It is widely used by Internet servers, including the majority of HTTPS websites.</p></blockquote><p><a href=https://en.wikipedia.org/wiki/OpenSSL>Source</a></p><h2 id=parsing-from-https-website>Parsing from <code>HTTPS</code> website</h2><div class="notices note"><p>the code explained here can be found in my <a href=https://github.com/jkotra/NetworkProgramming/blob/master/tls/get_https_webpage.c>NetworkProgramming GitHub repository</a>.</p></div><h3 id=tls>TLS</h3><blockquote><p>Transport Layer Security, and its now-deprecated predecessor, Secure Sockets Layer, are cryptographic protocols designed to provide communications security over a computer network. Several versions of the protocols find widespread use in applications such as web browsing, email, instant messaging, and voice over IP.</p></blockquote><p><a href=https://en.wikipedia.org/wiki/Transport_Layer_Security>Source</a></p><h3 id=walkthrough>Walkthrough</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;openssl/x509.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;openssl/crypto.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;openssl/pem.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;openssl/ssl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;openssl/err.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;openssl/evp.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/select.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;netinet/in.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;netdb.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdbool.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span></code></pre></div><p>We start by importing the required headers. Notice the OpenSSL headers, these contain essential functions to communicate securely with the website.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ssl initialization.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>SSL_library_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nf>OpenSSL_add_all_algorithms</span><span class=p>();</span>
</span></span></code></pre></div><p><code>main()</code> function takes two arguments, a domain name/ IP and a port/protocol. SSL port is <code>443</code>. we can also use <code>https</code>(which defaults to <code>443</code>) as the port. <code>getaddrinfo()</code> will understand it either way.</p><p>we need to initialize two functions, <code>SSL_library_init()</code> will set up the environment to use other functions of OpenSSL. <code>OpenSSL_add_all_algorithms()</code> will load required algorithms to encrypt, decrypt data and negotiate cipher with server.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=c1>//init context
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>SSL_CTX</span> <span class=o>*</span><span class=n>ctx</span> <span class=o>=</span> <span class=nf>SSL_CTX_new</span><span class=p>(</span><span class=nf>TLS_client_method</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;cannot create SSL context!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>we then need to initialize a context using <code>SSL_CTX_new()</code>. we pass a inbuilt constructor, <code>TLS_client_method()</code> indicating that we expect a client functionality.</p><div class="notices info"><p><p><code>TLS_method(), TLS_server_method(), TLS_client_method()</code></p><p>These are the general-purpose version-flexible SSL/TLS methods. The actual protocol version used will be negotiated to the highest version mutually supported by the client and the server. The supported protocols are SSLv3, TLSv1, TLSv1.1 and TLSv1.2. Applications should use these methods, and avoid the version-specific methods described below.</p><p><a href=https://www.openssl.org/docs/man1.1.0/man3/TLS_client_method.html>Source</a></p></p></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=cm>/* code taken from tcp_client_classic.c */</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>addrinfo</span> <span class=n>hints</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>hints</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>hints</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>addrinfo</span> <span class=o>*</span><span class=n>peer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>hints</span><span class=p>.</span><span class=n>ai_socktype</span> <span class=o>=</span> <span class=n>SOCK_STREAM</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;args: %s %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>getaddrinfo</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>hints</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>peer</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;addrinfo() error!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>peer_addr</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>peer_protocol</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nf>getnameinfo</span><span class=p>(</span><span class=n>peer</span><span class=o>-&gt;</span><span class=n>ai_addr</span><span class=p>,</span> <span class=n>peer</span><span class=o>-&gt;</span><span class=n>ai_addrlen</span><span class=p>,</span> <span class=n>peer_addr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>peer_addr</span><span class=p>),</span> <span class=n>peer_protocol</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>peer_protocol</span><span class=p>),</span> <span class=n>NI_NUMERICHOST</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;ip: %s | protocol: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>peer_addr</span><span class=p>,</span> <span class=n>peer_protocol</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//family socket_type protocol
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>socket_fd</span> <span class=o>=</span> <span class=nf>socket</span><span class=p>(</span><span class=n>peer</span><span class=o>-&gt;</span><span class=n>ai_family</span><span class=p>,</span> <span class=n>peer</span><span class=o>-&gt;</span><span class=n>ai_socktype</span><span class=p>,</span> <span class=n>peer</span><span class=o>-&gt;</span><span class=n>ai_protocol</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>socket_fd</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;socket error.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>connect</span><span class=p>(</span><span class=n>socket_fd</span><span class=p>,</span> <span class=n>peer</span><span class=o>-&gt;</span><span class=n>ai_addr</span><span class=p>,</span> <span class=n>peer</span><span class=o>-&gt;</span><span class=n>ai_addrlen</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;connect error.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;connected!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* END */</span>
</span></span></code></pre></div><p>The above code is directly taken from <code>tcp_client_classic.c</code> which is explained in <a href=/posts/network-programming-pt2/>this article</a>.</p><p>this essentially initiates a connection with the server, involving address resolution, socket creation, and <code>connect()</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=n>SSL</span> <span class=o>*</span><span class=n>ssl</span> <span class=o>=</span> <span class=nf>SSL_new</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;SSL_new() failed.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>next, we create an <code>SSL</code> pointer for peer(server). this will be used to communicate with the server replacing a <code>socket_fd</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>SSL_set_tlsext_host_name</span><span class=p>(</span><span class=n>ssl</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;SSL_set_tlsext_host_name() failed.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>The above code will ask the server to send details only related to the required website/Hostname. This is a necessary step if multiple sites are hosted under 1(single) IP. The server will then send a certificate pertaining to the hostname provided. it&rsquo;s up to us(client) to validate the details.</p><p>Usually, a self-signed certificate cannot be trusted, every OS comes with a set of trusted CA(certificate authorities) that are to be trusted. the client also must verify that the certificate is valid and not expired or yet-to-be issued.</p><p>(certificate validation is not covered in this article)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=nf>SSL_set_fd</span><span class=p>(</span><span class=n>ssl</span><span class=p>,</span> <span class=n>socket_fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>SSL_connect</span><span class=p>(</span><span class=n>ssl</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;SSL_connect() failed.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>In the above step, we connect our TCP socket to <code>SSL</code> using <code>SSL_set_fd</code>. from this point onwards (after <code>SSL_connect()</code>) we can communicate securely.</p><p><code>ssl_connect()</code> negotiates the best possible and mutually accepted cipher to decrypt and encrypt.it returns <code>-1</code> on error.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>printf</span><span class=p>(</span><span class=s>&#34;SSL/TLS using %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>SSL_get_cipher</span><span class=p>(</span><span class=n>ssl</span><span class=p>));</span>
</span></span></code></pre></div><p>(Optional) print the cipher being used using <code>SSL_get_cipher()</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>char</span> <span class=n>buffer</span><span class=p>[</span><span class=mi>2048</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>sprintf</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=s>&#34;GET / HTTP/1.1</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>sprintf</span><span class=p>(</span><span class=n>buffer</span> <span class=o>+</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>buffer</span><span class=p>),</span> <span class=s>&#34;Host: %s:%s</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>sprintf</span><span class=p>(</span><span class=n>buffer</span> <span class=o>+</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>buffer</span><span class=p>),</span> <span class=s>&#34;Connection: close</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>sprintf</span><span class=p>(</span><span class=n>buffer</span> <span class=o>+</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>buffer</span><span class=p>),</span> <span class=s>&#34;User-Agent: https_simple</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>sprintf</span><span class=p>(</span><span class=n>buffer</span> <span class=o>+</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>buffer</span><span class=p>),</span> <span class=s>&#34;</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>SSL_write</span><span class=p>(</span><span class=n>ssl</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>buffer</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Sent Headers:</span><span class=se>\n</span><span class=s>%s&#34;</span><span class=p>,</span> <span class=n>buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>bytes_received</span> <span class=o>=</span> <span class=nf>SSL_read</span><span class=p>(</span><span class=n>ssl</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buffer</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>bytes_received</span> <span class=o>&lt;</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>Connection closed by peer.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Received (%d bytes): &#39;%.*s&#39;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>bytes_received</span><span class=p>,</span> <span class=n>bytes_received</span><span class=p>,</span> <span class=n>buffer</span><span class=p>);</span>
</span></span></code></pre></div><p>The above code<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> declares a buffer. the buffer is filled with requred HTTP headers to make a request. <code>send()</code> is replaced by <code>SSL_write()</code> and <code>recv()</code> is replaced by <code>SSL_read()</code>.</p><p>the response is then stored into the <code>buffer</code>. the response is printed onto the screen.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=c1>// shutdown ssl connection and free() ctx. 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>SSL_shutdown</span><span class=p>(</span><span class=n>ssl</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>SSL_free</span><span class=p>(</span><span class=n>ssl</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>SSL_CTX_free</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// close socket
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>close</span><span class=p>(</span><span class=n>socket_fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Finally, we must clean up pointers n stuff, starting with OpenSSL. shutdown the current SSL connection using <code>SSL_shutdown()</code>, then free it from memory i.e <code>SSL_free(ssl)</code>. SSL context that is used to create SSL should be free&rsquo;d (since we are exiting the application, keep it around if you don&rsquo;t). Finally, as always, close the socket using <code>close()</code></p><h3 id=output>Output</h3><p>compile the program with GCC (remember to link with openSSL library)</p><p><code>gcc get_https_webpage.c -lcrypto -lssl</code></p><p>Run the program:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>~/Documents/Projects/network_programming/tls(master) Â» ./a.out example.org 443                                            jojo@synk
</span></span><span class=line><span class=cl>args: example.org 443
</span></span><span class=line><span class=cl>ip: 93.184.216.34 | protocol: https
</span></span><span class=line><span class=cl>connected!
</span></span><span class=line><span class=cl>SSL/TLS using TLS_AES_256_GCM_SHA384
</span></span><span class=line><span class=cl>Sent Headers:
</span></span><span class=line><span class=cl>GET / HTTP/1.1
</span></span><span class=line><span class=cl>Host: example.org:443
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>User-Agent: https_simple
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Received (370 bytes): &#39;HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Accept-Ranges: bytes
</span></span><span class=line><span class=cl>Age: 361373
</span></span><span class=line><span class=cl>Cache-Control: max-age=604800
</span></span><span class=line><span class=cl>Content-Type: text/html; charset=UTF-8
</span></span><span class=line><span class=cl>Date: Mon, 21 Sep 2020 18:13:25 GMT
</span></span><span class=line><span class=cl>Etag: &#34;3147526947&#34;
</span></span><span class=line><span class=cl>Expires: Mon, 28 Sep 2020 18:13:25 GMT
</span></span><span class=line><span class=cl>Last-Modified: Thu, 17 Oct 2019 07:18:26 GMT
</span></span><span class=line><span class=cl>Server: ECS (nyb/1D1B)
</span></span><span class=line><span class=cl>Vary: Accept-Encoding
</span></span><span class=line><span class=cl>X-Cache: HIT
</span></span><span class=line><span class=cl>Content-Length: 1256
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&#39;
</span></span></code></pre></div><p>Note, the response is only partial. <code>SSL_read()</code> must be run in a loop to receive until end.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Code was taken from <a href=https://github.com/codeplea/Hands-On-Network-Programming-with-C/blob/master/chap09/https_get.c>Hands-On Network Programming with C Code Repo</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=post-tags><nav class="nav tags"><ul class=flat><li><a href=/tags/network-programming>network programming</a></li><li><a href=/tags/c>c</a></li></ul></nav></div><div id=commento></div><script onload=setCommentsTheme() id=comments src=https://utteranc.es/client.js repo=jkotra/stdin.top-comments issue-term=pathname label=ðŸ’¬ theme=github-light crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the
<a href=https://commento.io/>comments powered by Commento.</a></noscript></div><link rel=stylesheet type=text/css href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.js></script>
<script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script></div></div><div class="footer wrapper"><script src=https://stdin.top/js/clipboard.min.988b4327074a4060e229a35c60cd186ef38420c9eb8b5eda4d19c4d29554742bf34e24b10eacaf02cce8d9a92e398fc4d47ed6a10f98d3f8a0bf68d2ac373e60.js integrity="sha512-mItDJwdKQGDiKaNcYM0YbvOEIMnri17aTRnE0pVUdCvzTiSxDqyvAszo2akuOY/E1H7WoQ+Y0/igv2jSrDc+YA=="></script><nav class=nav><div class=badge><a href=https://creativecommons.org/licenses/by-sa/4.0/ aria-label="CC BY-SA 4.0"><img alt="cc by-sa badge" src=/cc/by-sa.png></a></div><div><a href=https://github.com/jkotra/kavi-hugo-theme>Kavi</a> (based on <a href=https://github.com/vividvilla/ezhil>ezhil</a>)</a> | Built with <a href=https://gohugo.io>Hugo</a></div></nav></div></body></html>