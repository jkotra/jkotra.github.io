<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <base href="https://stdin.top/posts/https_parse_openssl/">
    
    

    
    <meta name="description" content="Integrate TLS with TCP to securely communicate ðŸ”’" />
    
    
    <meta name="language" content="en">
    <link rel="sitemap" type="application/xml" title="Sitemap" href="https://stdin.top/sitemap.xml" /> 

    
    
    
    <title>Parse HTTPS website(s) in C with OpenSSL :: &lt;stdin&gt;</title>
    

    <link rel="icon" type="image/png" href=/static/chip.png />

    <meta property="og:title" content="Parse HTTPS website(s) in C with OpenSSL" />
<meta property="og:description" content="Integrate TLS with TCP to securely communicate ðŸ”’" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://stdin.top/posts/https_parse_openssl/" />
<meta property="og:image" content="https://i.imgur.com/YGtDgXv.png" />
<meta property="article:published_time" content="2020-09-20T20:07:40+05:30" />
<meta property="article:modified_time" content="2020-09-20T20:07:40+05:30" />

    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://i.imgur.com/YGtDgXv.png"/>

<meta name="twitter:title" content="Parse HTTPS website(s) in C with OpenSSL"/>
<meta name="twitter:description" content="Integrate TLS with TCP to securely communicate ðŸ”’"/>


    <meta name="theme-color" content=#2e2847 />

    
    <link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tangerine&display=swap" rel="stylesheet">    

    
    
    <script src="https://stdin.top/js/main.min.ecbcd6a34b475cd2e844a02b80083902ac50d4c1f119178abd429ba42d436bfd4b5529b4a51b9127c9330664e1ad9e846c06f856295b40105bea6d7e2a6c3326.js" integrity="sha512-7LzWo0tHXNLoRKArgAg5AqxQ1MHxGReKvUKbpC1Da/1LVSm0pRuRJ8kzBmThrZ6EbAb4VilbQBBb6m1&#43;KmwzJg=="></script>

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/fontawesome.min.css" integrity="sha512-8jdwayz5n8F2cnW26l9vpV6+yGOcRAqz6HTu+DQ3FtVIAts2gTdlFZOGpYhvBMXkWEgxPN3Y22UWyZXuDowNLA==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/regular.min.css" integrity="sha512-qgtcTTDJDk6Fs9eNeN1tnuQwYjhnrJ8wdTVxJpUTkeafKKP6vprqRx5Sj/rB7Q57hoYDbZdtHR4krNZ/11zONg==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/brands.min.css" integrity="sha512-AMDXrE+qaoUHsd0DXQJr5dL4m5xmpkGLxXZQik2TvR2VCVKT/XRPQ4e/LTnwl84mCv+eFm92UG6ErWDtGM/Q5Q==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/solid.min.css" integrity="sha512-QN7X/bUbbeel9bbq6JVNJXk1Zowt+n+QPN+DjhEmTa4TdL1YPCsCey5JrvfRW8xp28LDYgGG/waNVdrhwMQmVQ==" crossorigin="anonymous" />
    
    
    
    <link rel="stylesheet" type="text/css" media="screen" href="https://stdin.top/css/main.min.1ce7be5e366f14daf317a7152f056779e6f7212332a7b6c19eae3e4166f9ce384eaaf8a136dac5f6655c635e25b47ead6ea92e5fbaf7ba0442a18b6559301c38.css" integrity="sha512-HOe&#43;XjZvFNrzF6cVLwVneeb3ISMyp7bBnq4&#43;QWb5zjhOqvihNtrF9mVcY14ltH6tbqkuX7r3ugRCoYtlWTAcOA==" />
    
    <link rel="stylesheet" type="text/css" media="screen" href="https://stdin.top/css/custom.min.3cfc3b65e14c57ead2c15971b0db9ea0e07766bdbd6b9d5e0c505cbaaba1ba9ebb679e5a3d1f7cbc87e9d4aa682a5faa0f6cd0fde39048f75616e7e407814468.css" integrity="sha512-PPw7ZeFMV&#43;rSwVlxsNueoOB3Zr29a51eDFBcuquhup67Z55aPR98vIfp1KpoKl&#43;qD2zQ/eOQSPdWFufkB4FEaA==" />
    
    
    <link rel="stylesheet" type="text/css" href="https://stdin.top/css/dark.min.18a12c0b44a31bf36562b7dd5981a47048a39252fcf3cbe20a3c7a9283ed7a89eaa695c1b3bad979b396fecd2eba78bb8bbb9793df539caa99562e3cca5519ee.css" media="(prefers-color-scheme: dark)">


    
    <link rel="stylesheet" type="text/css" media="screen" href="https://stdin.top/css/normalize.min.112c04d26fa13a6d29cec753a0959b82339c03760baa50dc705accbb85d7b83e02b7a3691b24d116b6e619c311eacb3f2f96529bcf0b45d8ae35759f9f35d52e.css" integrity="sha512-ESwE0m&#43;hOm0pzsdToJWbgjOcA3YLqlDccFrMu4XXuD4Ct6NpGyTRFrbmGcMR6ss/L5ZSm88LRdiuNXWfnzXVLg==" />


    
    

    

    

    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-YW8V9DTR0N"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', "G-YW8V9DTR0N" );
</script>



    
    
    <script data-ad-client=ca-pub-8658473214995139 async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    
    

</head>

<body>
    <div class="container wrapper">
    <div class="header">
	<base href="https://stdin.top/">
	<h1 class="site-title">
		
		<a href="https://stdin.top/">&lt;stdin&gt;</a>
		
		<span class="blinking-cursor">|</span>
		
	</h1>

	<div class="site-description">
		
		<h2 class="cursive">My Thoughts, Trials and Adventures</h2>
		

		<nav class="nav social">
			<ul class="flat">
				
				<a href="mailto:jagadeesh@stdin.top" title="Mail"><i class="far fa-envelope"></i></a>
				
				<a href="https://github.com/jkotra/" title="Github"><i class="fab fa-github"></i></a>
				
				<a href="https://twitter.com/jagadeesh_kotra" title="Twitter"><i class="fab fa-twitter"></i></a>
				
				<a href="index.xml" title="RSS"><i class="fas fa-rss"></i></a>
				
			</ul>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/about/">About</a>
			</li>
			
			<li>
				<a href="/tags/">Tags</a>
			</li>
			
			<li>
				<a href="/portfolio/">Portfolio</a>
			</li>
			
			<li>
				<a href="/pgp/">PGP</a>
			</li>
			
		</ul>
	</nav>
</div>

    
<div class= "post">
<div class="post-header">
	<h1 class="title">Parse HTTPS website(s) in C with OpenSSL</h1>
	
	<div class="meta">Posted at &mdash; Sep 20, 2020</div>
	
</div>

<div class="markdown">
	<h1 id="introduction">Introduction</h1>
<p>In this article, I will explain how to parse a website that uses  <code>HTTPS</code>. in the process, one must get a grip on OpenSSL and integrating it with TCP (TLS) to retrieve content.</p>
<h1 id="openssl">OpenSSL</h1>
<blockquote>
<p>OpenSSL is a software library for applications that secure communications over computer networks against eavesdropping or need to identify the party at the other end. It is widely used by Internet servers, including the majority of HTTPS websites.</p>
</blockquote>
<p><a href="https://en.wikipedia.org/wiki/OpenSSL">Source</a></p>
<h2 id="parsing-from-https-website">Parsing from <code>HTTPS</code> website</h2>
<div class="notices note" ><p>the code explained here can be found in my <a href="https://github.com/jkotra/NetworkProgramming/blob/master/tls/get_https_webpage.c">NetworkProgramming GitHub repository</a>.</p></div>
<h3 id="tls">TLS</h3>
<blockquote>
<p>Transport Layer Security, and its now-deprecated predecessor, Secure Sockets Layer, are cryptographic protocols designed to provide communications security over a computer network. Several versions of the protocols find widespread use in applications such as web browsing, email, instant messaging, and voice over IP.</p>
</blockquote>
<p><a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">Source</a></p>
<h3 id="walkthrough">Walkthrough</h3>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;openssl/x509.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;openssl/crypto.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;openssl/pem.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;openssl/ssl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;openssl/err.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;openssl/evp.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/select.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;netinet/in.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;netdb.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span></code></pre></div><p>We start by importing the required headers. Notice the OpenSSL headers, these contain essential functions to communicate securely with the website.</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>

    <span class="c1">// ssl initialization.
</span><span class="c1"></span>    <span class="n">SSL_library_init</span><span class="p">();</span>
    <span class="n">OpenSSL_add_all_algorithms</span><span class="p">();</span>
</code></pre></div><p><code>main()</code> function takes two arguments, a domain name/ IP and a port/protocol. SSL port is <code>443</code>. we can also use <code>https</code>(which defaults to <code>443</code>) as the port. <code>getaddrinfo()</code> will understand it either way.</p>
<p>we need to initialize two functions, <code>SSL_library_init()</code> will set up the environment to use other functions of OpenSSL. <code>OpenSSL_add_all_algorithms()</code> will load required algorithms to encrypt, decrypt data and negotiate cipher with server.</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c">    <span class="c1">//init context
</span><span class="c1"></span>    <span class="n">SSL_CTX</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">SSL_CTX_new</span><span class="p">(</span><span class="n">TLS_client_method</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;cannot create SSL context!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div><p>we then need to initialize a context using <code>SSL_CTX_new()</code>. we pass a inbuilt constructor, <code>TLS_client_method()</code> indicating that we expect a client functionality.</p>
<div class="notices info" ><p><p><code>TLS_method(), TLS_server_method(), TLS_client_method()</code></p>
<p>These are the general-purpose version-flexible SSL/TLS methods. The actual protocol version used will be negotiated to the highest version mutually supported by the client and the server. The supported protocols are SSLv3, TLSv1, TLSv1.1 and TLSv1.2. Applications should use these methods, and avoid the version-specific methods described below.</p>
<p><a href="https://www.openssl.org/docs/man1.1.0/man3/TLS_client_method.html">Source</a></p>
</p></div>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c">    <span class="cm">/* code taken from tcp_client_classic.c */</span>
    <span class="k">struct</span> <span class="n">addrinfo</span> <span class="n">hints</span><span class="p">;</span>

    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hints</span><span class="p">));</span>

    <span class="k">struct</span> <span class="n">addrinfo</span> <span class="o">*</span><span class="n">peer</span><span class="p">;</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">SOCK_STREAM</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;args: %s %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">peer</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;addrinfo() error!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">char</span> <span class="n">peer_addr</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">peer_protocol</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
    <span class="n">getnameinfo</span><span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">,</span> <span class="n">peer_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">peer_addr</span><span class="p">),</span> <span class="n">peer_protocol</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">peer_protocol</span><span class="p">),</span> <span class="n">NI_NUMERICHOST</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;ip: %s | protocol: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">peer_addr</span><span class="p">,</span> <span class="n">peer_protocol</span><span class="p">);</span>

    <span class="c1">//family socket_type protocol
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">socket_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">socket_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;socket error.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;connect error.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;connected!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>

    <span class="cm">/* END */</span>
</code></pre></div><p>The above code is directly taken from <code>tcp_client_classic.c</code> which is explained in <a href="/posts/network-programming-pt2/">this article</a>.</p>
<p>this essentially initiates a connection with the server, involving address resolution, socket creation, and <code>connect()</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c">    <span class="n">SSL</span> <span class="o">*</span><span class="n">ssl</span> <span class="o">=</span> <span class="n">SSL_new</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;SSL_new() failed.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div><p>next, we create an <code>SSL</code> pointer for peer(server). this will be used to communicate with the server replacing a <code>socket_fd</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SSL_set_tlsext_host_name</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;SSL_set_tlsext_host_name() failed.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div><p>The above code will ask the server to send details only related to the required website/Hostname. This is a necessary step if multiple sites are hosted under 1(single) IP. The server will then send a certificate pertaining to the hostname provided. it&rsquo;s up to us(client) to validate the details.</p>
<p>Usually, a self-signed certificate cannot be trusted, every OS comes with a set of trusted CA(certificate authorities) that are to be trusted. the client also must verify that the certificate is valid and not expired or yet-to-be issued.</p>
<p>(certificate validation is not covered in this article)</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c">    <span class="n">SSL_set_fd</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="n">socket_fd</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SSL_connect</span><span class="p">(</span><span class="n">ssl</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;SSL_connect() failed.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div><p>In the above step, we connect our TCP socket to <code>SSL</code> using <code>SSL_set_fd</code>. from this point onwards (after <code>SSL_connect()</code>) we can communicate securely.</p>
<p><code>ssl_connect()</code> negotiates the best possible and mutually accepted cipher to decrypt and encrypt.it returns <code>-1</code> on error.</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="n">printf</span><span class="p">(</span><span class="s">&#34;SSL/TLS using %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">SSL_get_cipher</span><span class="p">(</span><span class="n">ssl</span><span class="p">));</span>
</code></pre></div><p>(Optional) print the cipher being used using <code>SSL_get_cipher()</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span>

    <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&#34;GET / HTTP/1.1</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="s">&#34;Host: %s:%s</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="s">&#34;Connection: close</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="s">&#34;User-Agent: https_simple</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="s">&#34;</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>

    <span class="n">SSL_write</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Sent Headers:</span><span class="se">\n</span><span class="s">%s&#34;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">bytes_received</span> <span class="o">=</span> <span class="n">SSL_read</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bytes_received</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">Connection closed by peer.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Received (%d bytes): &#39;%.*s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">bytes_received</span><span class="p">,</span> <span class="n">bytes_received</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
</code></pre></div><p>The above code<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> declares a buffer. the buffer is filled with requred HTTP headers to make a request. <code>send()</code> is replaced by <code>SSL_write()</code> and <code>recv()</code> is replaced by <code>SSL_read()</code>.</p>
<p>the response is then stored into the <code>buffer</code>. the response is printed onto the screen.</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c">    <span class="c1">// shutdown ssl connection and free() ctx. 
</span><span class="c1"></span>    <span class="n">SSL_shutdown</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
    <span class="n">SSL_free</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
    <span class="n">SSL_CTX_free</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
    
    <span class="c1">// close socket
</span><span class="c1"></span>    <span class="n">close</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>Finally, we must clean up pointers n stuff, starting with OpenSSL. shutdown the current SSL connection using <code>SSL_shutdown()</code>, then free it from memory i.e <code>SSL_free(ssl)</code>. SSL context that is used to create SSL should be free&rsquo;d (since we are exiting the application, keep it around if you don&rsquo;t). Finally, as always, close the socket using <code>close()</code></p>
<h3 id="output">Output</h3>
<p>compile the program with GCC (remember to link with openSSL library)</p>
<p><code>gcc get_https_webpage.c -lcrypto -lssl</code></p>
<p>Run the program:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">~/Documents/Projects/network_programming/tls(master) Â» ./a.out example.org 443                                            jojo@synk
args: example.org 443
ip: 93.184.216.34 | protocol: https
connected!
SSL/TLS using TLS_AES_256_GCM_SHA384
Sent Headers:
GET / HTTP/1.1
Host: example.org:443
Connection: close
User-Agent: https_simple

Received (370 bytes): &#39;HTTP/1.1 200 OK
Accept-Ranges: bytes
Age: 361373
Cache-Control: max-age=604800
Content-Type: text/html; charset=UTF-8
Date: Mon, 21 Sep 2020 18:13:25 GMT
Etag: &#34;3147526947&#34;
Expires: Mon, 28 Sep 2020 18:13:25 GMT
Last-Modified: Thu, 17 Oct 2019 07:18:26 GMT
Server: ECS (nyb/1D1B)
Vary: Accept-Encoding
X-Cache: HIT
Content-Length: 1256
Connection: close

&#39;

</code></pre></div><p>Note, the response is only partial. <code>SSL_read()</code> must be run in a loop to receive until end.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>Code was taken from <a href="https://github.com/codeplea/Hands-On-Network-Programming-with-C/blob/master/chap09/https_get.c">Hands-On Network Programming with C Code Repo</a> <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

</div>

<div class="post-tags">
	
	
	<nav class="nav tags">
		<ul class="flat">
			
			<li><a href="/tags/network-programming">network programming</a></li>
			
			<li><a href="/tags/c">c</a></li>
			
		</ul>
	</nav>
	
	
</div>

<div id="commento"></div>

<script id="comments" src="https://utteranc.es/client.js" repo="jkotra/stdin.top-comments" issue-term="pathname"
	label="ðŸ’¬" theme="github-light" crossorigin="anonymous" async>
	</script>

<noscript>Please enable JavaScript to view the
	<a href="https://commento.io/">comments powered by Commento.</a>
</noscript>

</div>





<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>



</div>


    </div>

    <div class="footer wrapper">

			

	<nav class="nav">
		<div class="badge"><a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="/cc/by-sa.png"></a></div>
		<div> <a href="https://github.com/jkotra/kavi-hugo-theme">Kavi</a> (based on <a href="https://github.com/vividvilla/ezhil">ezhil</a>)</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>

</body>

</html>